<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${chapter != null ? chapter.title : 'Reader'}">Reader</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body class="reader-mode">

    <!-- Reader Toolbar -->
    <header class="toolbar">
        <div class="toolbar-inner">
            <a href="/docs/stories" class="brand">‚Üê Library</a>

            <div class="controls">
                <!-- Work Mode Toggle -->
                <button class="control-btn" onclick="toggleWorkMode()" id="workModeBtn" title="Stealth Mode">
                    üíº Work Mode
                </button>

                <!-- Theme Switcher -->
                <div class="control-group" role="group" aria-label="Theme Selection">
                    <button class="control-btn active" onclick="setTheme('light')"
                        aria-label="Light Theme">Light</button>
                    <button class="control-btn" onclick="setTheme('sepia')" aria-label="Sepia Theme">Sepia</button>
                    <button class="control-btn" onclick="setTheme('gray')" aria-label="Gray Theme">Gray</button>
                    <button class="control-btn" onclick="setTheme('dark')" aria-label="Dark Theme">Dark</button>
                </div>

                <!-- Font Size Controls -->
                <div class="control-group" role="group" aria-label="Font Size">
                    <button class="control-btn" onclick="adjustFontSize(-2)" aria-label="Decrease Font Size">A‚àí</button>
                    <button class="control-btn" onclick="adjustFontSize(2)" aria-label="Increase Font Size">A+</button>
                </div>

                <!-- TTS Controls -->
                <div class="control-group">
                    <button class="control-btn" onclick="toggleAudio()" id="ttsBtn" aria-label="Play Audio">
                        üîä Play
                    </button>
                    <button class="control-btn" onclick="toggleSettings()" id="settingsBtn" aria-label="TTS Settings">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Reading Area -->
    <main class="reader-container" id="mainContainer">

        <!-- Fake Sidebar Left -->
        <aside class="sidebar-left">
            <div class="sidebar-title">Project Structure</div>
            <ul class="sidebar-list">
                <li><a href="#">Introduction</a></li>
                <li><a href="#">Getting Started</a></li>
                <li><a href="#" class="active-item">Architecture Overview</a></li>
                <li><a href="#">Authentication</a></li>
                <li><a href="#">API Endpoints</a></li>
                <li><a href="#">Database Schema</a></li>
            </ul>
            <div class="sidebar-title">Configuration</div>
            <ul class="sidebar-list">
                <li><a href="#">Environment Variables</a></li>
                <li><a href="#">Docker Setup</a></li>
                <li><a href="#">CI/CD Pipelines</a></li>
            </ul>
            <div class="sidebar-title">Security Module</div>
            <ul class="sidebar-list">
                <li><a href="#">OAuth2 Implementation</a></li>
                <li><a href="#">Role Based Access</a></li>
                <li><a href="#">Audit Logging</a></li>
                <li><a href="#">Encryption Standards</a></li>
            </ul>
            <div class="sidebar-title">Infrastructure</div>
            <ul class="sidebar-list">
                <li><a href="#">AWS CloudFormation</a></li>
                <li><a href="#">Kubernetes Manifests</a></li>
                <li><a href="#">Load Balancing</a></li>
                <li><a href="#">Disaster Recovery</a></li>
            </ul>
        </aside>

        <article>
            <header>
                <div class="confidential-badge">Confidential</div>
                <h1 th:text="${chapter != null ? chapter.title : 'Chapter Title'}">Chapter Title</h1>
                <div class="meta-info">
                    <span th:if="${story != null}" th:text="${story.name}">Story Name</span>
                    <span th:if="${chapterIndex != null}"> ‚Ä¢ Section <span th:text="${chapterIndex}">1</span></span>
                </div>
            </header>

            <!-- Content -->
            <div class="chapter-content" id="chapter-text" th:if="${chapter != null and chapter.content != null}">
                <div th:utext="${chapter.content}">
                    <p>Lorem ipsum dolor sit amet...</p>
                </div>
            </div>

            <div th:if="${chapter == null}" class="chapter-content">
                <p>No content available.</p>
            </div>

            <!-- Navigation Footer -->
            <nav class="story-nav">
                <a th:if="${previousChapter != null}"
                    th:href="@{/docs/stories/{storyName}/chapters/{chapterId}(storyName=${story.name}, chapterId=${previousChapter.id})}"
                    class="nav-link">‚Üê Previous</a>
                <span th:if="${previousChapter == null}" class="nav-link disabled">‚Üê Previous</span>

                <a th:if="${nextChapter != null}"
                    th:href="@{/docs/stories/{storyName}/chapters/{chapterId}(storyName=${story.name}, chapterId=${nextChapter.id})}"
                    class="nav-link">Next ‚Üí</a>
                <span th:if="${nextChapter == null}" class="nav-link disabled">Next ‚Üí</span>
            </nav>

        </article>

        <!-- Fake Sidebar Right -->
        <aside class="sidebar-right">
            <div class="sidebar-title">On this page</div>
            <ul class="sidebar-list">
                <li><a href="#">Summary</a></li>
                <li><a href="#">Specifications</a></li>
                <li><a href="#">Implementation Details</a></li>
                <li><a href="#">Dependencies</a></li>
                <li><a href="#">Risk Assessment</a></li>
            </ul>
            <div class="sidebar-title">Related Pages</div>
            <ul class="sidebar-list">
                <li><a href="#">Frontend Guidelines</a></li>
                <li><a href="#">Backend API V2</a></li>
                <li><a href="#">Legacy Migration</a></li>
            </ul>
            <div class="sidebar-title">Contributors</div>
            <div class="page-meta-list">
                <div style="font-size: 13px; color: var(--ui-text); margin-bottom: 8px;">Created by <br><strong>Admin
                        User</strong></div>
                <div style="font-size: 13px; color: var(--ui-text);">Last updated <br><strong>Today</strong></div>
            </div>
            <div style="margin-top: 2rem;">
                <a href="#" style="font-size: 13px; color: var(--link-color);">‚¨á Export to PDF</a>
            </div>
        </aside>

    </main>

    <!-- TTS Settings Modal -->
    <div class="modal-overlay" id="ttsSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">TTS Settings</h3>
                <button class="close-modal" onclick="toggleSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="voiceSelect">Voice</label>
                    <select id="voiceSelect" class="form-select" onchange="updateVoice()">
                        <option value="">Default</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="rateRange">Speed: <span id="rateValue"
                            class="range-value">1.0x</span></label>
                    <input type="range" id="rateRange" class="form-range" min="0.5" max="2.0" step="0.1" value="1.0"
                        oninput="updateRate()">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Reader Logic
        const body = document.body;
        const mainContainer = document.getElementById('mainContainer');
        const buttons = document.querySelectorAll('[onclick^="setTheme"]');
        const workModeBtn = document.getElementById('workModeBtn');

        // Font Size State
        let currentFontSize = 20;

        // Initialize from localStorage
        function initReader() {
            const savedTheme = localStorage.getItem('readerTheme') || 'light';
            const savedSize = localStorage.getItem('readerFontSize');
            const savedWorkMode = localStorage.getItem('readerWorkMode') === 'true';

            setTheme(savedTheme, false);

            if (savedSize) {
                currentFontSize = parseInt(savedSize);
                applyFontSize();
            }

            if (savedWorkMode) {
                toggleWorkMode(false);
            }
        }

        // Work Mode Logic
        function toggleWorkMode(save = true) {
            body.classList.toggle('work-mode');
            mainContainer.classList.toggle('work-mode-layout');

            const isActive = body.classList.contains('work-mode');

            if (isActive) {
                workModeBtn.classList.add('active');
                workModeBtn.textContent = 'Reading Mode';
                // Theme is now preserved/selectable
            } else {
                workModeBtn.classList.remove('active');
                workModeBtn.textContent = 'üíº Work Mode';
                // Restore user theme
                const savedTheme = localStorage.getItem('readerTheme') || 'light';
                setTheme(savedTheme, false);
            }

            if (save) localStorage.setItem('readerWorkMode', isActive);
        }

        // Theme Switcher
        function setTheme(themeName, save = true) {
            // Set Attribute
            if (themeName === 'light') {
                body.removeAttribute('data-theme');
            } else {
                body.setAttribute('data-theme', themeName);
            }

            // Update Buttons
            buttons.forEach(btn => {
                const label = btn.getAttribute('aria-label').toLowerCase();
                if (label.includes(themeName)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (save) localStorage.setItem('readerTheme', themeName);
        }

        // Font Size Adjustment
        function adjustFontSize(delta) {
            currentFontSize += delta;

            // Clamp between 18px and 26px (extended range for flexibility)
            if (currentFontSize < 16) currentFontSize = 16;
            if (currentFontSize > 28) currentFontSize = 28;

            applyFontSize();
            localStorage.setItem('readerFontSize', currentFontSize);
        }

        function applyFontSize() {
            body.style.fontSize = currentFontSize + 'px';
        }

        // Run Init
        initReader();

        // TTS Logic
        const ttsBtn = document.getElementById('ttsBtn');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateRange = document.getElementById('rateRange');
        const rateValue = document.getElementById('rateValue');

        // State
        let isSpeaking = false;
        let isPaused = false;
        let isListenMode = false;

        let ttsSentences = [];     // Array of span elements
        let currentSentenceIdx = 0;
        let voices = [];
        let selectedVoiceIndex = -1;
        let currentRate = 1.0;

        // Dom Prepared Flag
        let isContentPrepared = false;
        let originalContentHTML = '';
        let wasWorkModeActive = false;

        // Settings Modal
        function toggleSettings() {
            const modal = document.getElementById('ttsSettingsModal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                loadVoices();
            }
        }

        // Voice Loading (Existing robust version)
        function loadVoices() {
            const allVoices = window.speechSynthesis.getVoices();
            if (allVoices.length === 0) return;

            voices = allVoices.filter(voice => voice.lang.includes('vi'));

            voiceSelect.innerHTML = '';

            if (voices.length === 0) {
                const option = document.createElement('option');
                option.textContent = "No Vietnamese voices found";
                option.value = -1;
                voiceSelect.appendChild(option);
                voiceSelect.disabled = true;
            } else {
                voiceSelect.disabled = false;

                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = index;
                    voiceSelect.appendChild(option);
                });

                const savedVoiceName = localStorage.getItem('ttsVoiceName');
                let foundIndex = -1;

                if (savedVoiceName) foundIndex = voices.findIndex(v => v.name === savedVoiceName);

                if (foundIndex !== -1) {
                    voiceSelect.value = foundIndex;
                    selectedVoiceIndex = foundIndex;
                } else {
                    const hoaiMyIndex = voices.findIndex(v => v.name.toLowerCase().includes("hoai my"));
                    if (hoaiMyIndex !== -1) {
                        voiceSelect.value = hoaiMyIndex;
                        selectedVoiceIndex = hoaiMyIndex;
                    } else {
                        voiceSelect.value = 0;
                        selectedVoiceIndex = 0;
                    }
                    if (voices[selectedVoiceIndex]) localStorage.setItem('ttsVoiceName', voices[selectedVoiceIndex].name);
                }
            }

            const savedRate = localStorage.getItem('ttsRate');
            if (savedRate) {
                currentRate = parseFloat(savedRate);
                rateRange.value = currentRate;
                rateValue.textContent = currentRate + 'x';
            }
        }

        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function updateVoice() {
            selectedVoiceIndex = parseInt(voiceSelect.value);
            if (voices[selectedVoiceIndex]) localStorage.setItem('ttsVoiceName', voices[selectedVoiceIndex].name);
            if (isSpeaking && !isPaused) {
                window.speechSynthesis.cancel();
                speakSentence();
            }
        }

        function updateRate() {
            currentRate = parseFloat(rateRange.value);
            rateValue.textContent = currentRate + 'x';
            localStorage.setItem('ttsRate', currentRate);
            if (isSpeaking && !isPaused) {
                window.speechSynthesis.cancel();
                speakSentence();
            }
        }

        // --- Core TTS Logic ---

        function enterListenMode() {
            if (isListenMode) return;
            isListenMode = true;

            // 1. Save Original Content
            const contentDiv = document.getElementById('chapter-text');
            originalContentHTML = contentDiv.innerHTML;

            // 2. Switch to Work Mode (Listen Layout) if not active
            wasWorkModeActive = document.body.classList.contains('work-mode');
            if (!wasWorkModeActive) {
                toggleWorkMode(false); // Enable temp
            }

            // 3. Prepare Content (Destructive)
            prepareContent();

            // 4. Show Stop Button (Create logic or Toggle visibility)
            // We'll update the button text in toggleAudio mostly, looking for where to place Stop
        }

        function exitListenMode() {
            if (!isListenMode) return;

            // 1. Stop Audio
            resetTTS();

            // 2. Restore Content
            const contentDiv = document.getElementById('chapter-text');
            if (originalContentHTML) {
                contentDiv.innerHTML = originalContentHTML;
            }

            // 3. Restore Layout
            if (!wasWorkModeActive && document.body.classList.contains('work-mode')) {
                toggleWorkMode(false); // Disable temp
            }

            // 4. Reset Flags
            isListenMode = false;
            isContentPrepared = false;
            originalContentHTML = '';

            // Reset UI
            ttsBtn.textContent = 'üîä Play';
            ttsBtn.classList.remove('active');
        }

        function prepareContent() {
            if (isContentPrepared) return;

            const contentDiv = document.getElementById('chapter-text');
            let blocks = Array.from(contentDiv.querySelectorAll('p'));

            if (blocks.length === 0) {
                blocks = Array.from(contentDiv.querySelectorAll('div'));
                if (blocks.length === 0 && contentDiv.innerText.trim().length > 0) {
                    blocks = [contentDiv];
                }
            }

            if (blocks.length === 0) return;

            let globalIndex = 0;

            blocks.forEach(block => {
                if (!block.innerText.trim()) return;
                if (block.querySelector('.tts-sentence')) return;

                const text = block.innerText;
                const sentences = text.match(/[^.?!]+[.?!]+|[^.?!]+$/g);

                if (sentences && sentences.length > 0) {
                    block.innerHTML = '';
                    sentences.forEach(s => {
                        if (!s.trim()) return;
                        const span = document.createElement('span');
                        span.className = 'tts-sentence';
                        span.textContent = s;
                        span.dataset.idx = globalIndex++;
                        block.appendChild(span);
                        block.appendChild(document.createTextNode(' '));
                    });
                }
            });

            ttsSentences = document.querySelectorAll('.tts-sentence');
            if (ttsSentences.length > 0) {
                isContentPrepared = true;
            }
        }

        function toggleAudio() {
            // First click: Enter Listen Mode
            if (!isListenMode) {
                enterListenMode();
                if (voices.length === 0) loadVoices();

                isSpeaking = true;
                isPaused = false;
                ttsBtn.textContent = '‚è∏ Pause';
                ttsBtn.classList.add('active');
                speakSentence();

                // Add a Stop button if it doesn't exist
                addStopButton();
                return;
            }

            // Subsequent clicks: Pause/Resume
            if (isSpeaking && !isPaused) {
                // Pause
                window.speechSynthesis.cancel();
                isPaused = true;
                ttsBtn.textContent = '‚ñ∂ Resume';
            } else {
                // Resume
                isSpeaking = true;
                isPaused = false;
                ttsBtn.textContent = '‚è∏ Pause';
                speakSentence();
            }
        }

        function addStopButton() {
            if (document.getElementById('ttsStopBtn')) return;

            const stopBtn = document.createElement('button');
            stopBtn.id = 'ttsStopBtn';
            stopBtn.className = 'control-btn active'; // Style it
            stopBtn.style.marginLeft = '8px';
            stopBtn.textContent = '‚èπ Stop';
            stopBtn.onclick = () => {
                exitListenMode();
                stopBtn.remove();
            };

            // Insert after play button
            ttsBtn.parentNode.insertBefore(stopBtn, ttsBtn.nextSibling);
        }

        function speakSentence() {
            if (!isListenMode) return;

            if (currentSentenceIdx >= ttsSentences.length) {
                exitListenMode();
                const stopBtn = document.getElementById('ttsStopBtn');
                if (stopBtn) stopBtn.remove();
                return;
            }

            document.querySelectorAll('.tts-highlight').forEach(el => el.classList.remove('tts-highlight'));

            const sentenceEl = ttsSentences[currentSentenceIdx];
            if (!sentenceEl) return;

            sentenceEl.classList.add('tts-highlight');
            sentenceEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const utterance = new SpeechSynthesisUtterance(sentenceEl.innerText);
            utterance.rate = currentRate;
            utterance.pitch = 1.0;
            if (selectedVoiceIndex >= 0 && voices[selectedVoiceIndex]) {
                utterance.voice = voices[selectedVoiceIndex];
            }

            utterance.onend = () => {
                if (!isSpeaking || isPaused) return;
                currentSentenceIdx++;
                speakSentence();
            };

            utterance.onerror = (e) => {
                console.error("TTS Error", e);
                if (isSpeaking && !isPaused) {
                    currentSentenceIdx++;
                    speakSentence();
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        function resetTTS() {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            isPaused = false;
            currentSentenceIdx = 0;
            document.querySelectorAll('.tts-highlight').forEach(el => el.classList.remove('tts-highlight'));
        }

        // Initial Load
        loadVoices();

        // Stop audio when leaving the page or unloading
        window.addEventListener('beforeunload', () => {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        });
    </script>
</body>

</html>